{-# LANGUAGE CPP                   #-}
{-# LANGUAGE DataKinds             #-}
{-# LANGUAGE FlexibleInstances     #-}
{-# LANGUAGE MultiParamTypeClasses #-}
{-# LANGUAGE OverloadedStrings     #-}
{-# LANGUAGE RankNTypes            #-}
{-# LANGUAGE TypeSynonymInstances  #-}

module Main where

import           Control.Monad                             (unless)
import qualified Data.Map                                  as Map
import           Data.Monoid                               ((<>))
import           Data.Proxy
import qualified Data.Text                                 as T
import           Language.PureScript.Bridge
import           Language.PureScript.Bridge.TypeParameters
import           Test.Hspec                                (Spec, describe,
                                                            hspec, it)
import           Test.Hspec.Expectations.Pretty

import           TestData



main :: IO ()
main = hspec $ do allTests


allTests :: Spec
allTests =
  describe "buildBridge" $ do
    it "tests with Int" $
      let bst = buildBridge defaultBridge (mkTypeInfo (Proxy :: Proxy Int))
          ti  = TypeInfo { _typePackage    = "purescript-prim"
                       , _typeModule     = "Prim"
                       , _typeName       = "Int"
                       , _typeParameters = []}
       in bst `shouldBe` ti
    it "tests with custom type Foo" $
      let bst = bridgeSumType (buildBridge defaultBridge) (mkSumType (Proxy :: Proxy Foo))
          st = SumType
                TypeInfo { _typePackage = "" , _typeModule = "TestData" , _typeName = "Foo" , _typeParameters = [] }
                [ DataConstructor { _sigConstructor = "Foo" , _sigValues = Left [] }
                , DataConstructor
                  { _sigConstructor = "Bar"
                  , _sigValues = Left [ TypeInfo { _typePackage = "purescript-prim" , _typeModule = "Prim" , _typeName = "Int" , _typeParameters = [] } ]
                  }
                , DataConstructor
                  { _sigConstructor = "FooBar"
                  , _sigValues = Left [ TypeInfo { _typePackage = "purescript-prim" , _typeModule = "Prim" , _typeName = "Int" , _typeParameters = [] }
                                      , TypeInfo { _typePackage = "purescript-prim" , _typeModule = "Prim" , _typeName = "String" , _typeParameters = [] }
                                      ]
                  }
                ]
       in bst `shouldBe` st
    it "tests the generation of a whole (dummy) module" $
      let advanced = bridgeSumType (buildBridge defaultBridge) (mkSumType (Proxy :: Proxy (Bar A B M1 C)))
          modules = sumTypeToModule advanced Map.empty
          m = head . map moduleToText . Map.elems $ modules
          txt = T.unlines [ "-- File auto generated by purescript-bridge! --"
                          , "module TestData where"
                          , ""
                          , "import Data.Either (Either)"
                          , "import Data.Maybe (Maybe)"
                          , ""
                          , "import Data.Generic (class Generic)"
                          , ""
                          , ""
                          , "data Bar a b m c ="
                          , "    Bar1 (Maybe a)"
                          , "  | Bar2 (Either a b)"
                          , "  | Bar3 a"
                          , "  | Bar4 {"
                          , "      myMonadicResult :: m b"
                          , "    }"
                          , ""
                          , "derive instance genericBar :: (Generic a, Generic b, Generic (m b)) => Generic (Bar a b m c)"
                          , ""
                          ]
      in m `shouldBe` txt
    it "test generation of Prisms" $
      let bar = bridgeSumType (buildBridge defaultBridge) (mkSumType (Proxy :: Proxy (Bar A B M1 C)))
          foo = bridgeSumType (buildBridge defaultBridge) (mkSumType (Proxy :: Proxy Foo))
          barPrisms = sumTypeToPrismsAndLenses bar
          fooPrisms = sumTypeToPrismsAndLenses foo
          txt = T.unlines [
                            "_Bar1 :: PrismP (Bar a b m c) (Maybe a)"
                          , "_Bar1 = prism' Bar1 f"
                          , "  where"
                          , "    f a = Just $ Bar1 a"
                          , "_Bar2 :: PrismP (Bar a b m c) (Either a b)"
                          , "_Bar2 = prism' Bar2 f"
                          , "  where"
                          , "    f a = Just $ Bar2 a"
                          , "_Bar3 :: PrismP (Bar a b m c) a"
                          , "_Bar3 = prism' Bar3 f"
                          , "  where"
                          , "    f a = Just $ Bar3 a"
                          , "_Bar4 :: PrismP (Bar a b m c) { myMonadicResult :: m b}"
                          , "_Bar4 = prism' Bar4 f"
                          , "  where"
                          , "    f (Bar4 r) = Just r"
                          , "    f _ = Nothing"
                          , ""
                          , "_Foo :: PrismP Foo {  }"
                          , "_Foo = prism' Foo f"
                          , "  where"
                          , "    f _ = Just Foo"
                          , "_Bar :: PrismP Foo Int"
                          , "_Bar = prism' Bar f"
                          , "  where"
                          , "    f a = Just $ Bar a"
                          , "_FooBar :: PrismP Foo { a :: Int, b :: String }"
                          , "_FooBar = prism' FooBar f"
                          , "  where"
                          , "    f { a: a, b: b } = Just $ FooBar a b"
                          ]
      in (barPrisms <> fooPrisms) `shouldBe` txt

st = SumType (TypeInfo {_typePackage = "", _typeModule = "TestData", _typeName = "Bar", _typeParameters = [TypeInfo {_typePackage = "purescript-prim", _typeModule = "Prim", _typeName = "Int", _typeParameters = []},TypeInfo {_typePackage = "purescript-prim", _typeModule = "Prim", _typeName = "Int", _typeParameters = []},TypeInfo {_typePackage = "purescript-maybe", _typeModule = "Data.Maybe", _typeName = "Maybe", _typeParameters = []},TypeInfo {_typePackage = "purescript-prim", _typeModule = "Prim", _typeName = "String", _typeParameters = []}]}) [DataConstructor {_sigConstructor = "Bar1", _sigValues = Left [TypeInfo {_typePackage = "purescript-maybe", _typeModule = "Data.Maybe", _typeName = "Maybe", _typeParameters = [TypeInfo {_typePackage = "purescript-prim", _typeModule = "Prim", _typeName = "Int", _typeParameters = []}]}]},DataConstructor {_sigConstructor = "Bar2", _sigValues = Left [TypeInfo {_typePackage = "purescript-either", _typeModule = "Data.Either", _typeName = "Either", _typeParameters = [TypeInfo {_typePackage = "purescript-prim", _typeModule = "Prim", _typeName = "Int", _typeParameters = []},TypeInfo {_typePackage = "purescript-prim", _typeModule = "Prim", _typeName = "Int", _typeParameters = []}]}]},DataConstructor {_sigConstructor = "Bar3", _sigValues = Left [TypeInfo {_typePackage = "purescript-prim", _typeModule = "Prim", _typeName = "Int", _typeParameters = []}]},DataConstructor {_sigConstructor = "Bar4", _sigValues = Right [RecordEntry {_recLabel = "myMonadicResult", _recValue = TypeInfo {_typePackage = "purescript-maybe", _typeModule = "Data.Maybe", _typeName = "Maybe", _typeParameters = [TypeInfo {_typePackage = "purescript-prim", _typeModule = "Prim", _typeName = "Int", _typeParameters = []}]}}]}]
